{% extends "base.html" %}

{% block title %}Exportar{% endblock %}

{% block content %}
<div class="col-md-9">
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Documentos Disponibles para Exportar</h5>
            <button id="refreshDocsBtn" class="btn btn-sm btn-secondary">
                <i class="fas fa-sync-alt me-1"></i> Actualizar
            </button>
        </div>
        <div class="card-body">
            <div id="exportableDocsContainer">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Cargando documentos...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-md-3">
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="card-title mb-0">Opciones de Exportación</h5>
        </div>
        <div class="card-body">
            <!-- Controles actualizados... -->
            <div class="text-center mb-4" id="exportControls">
                <button id="generateReportBtn" class="btn btn-info btn-lg w-100 mb-3">
                    <i class="fas fa-file-excel me-2"></i> Generar Cuadratura
                </button>
                
                <button id="exportDataBtn" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-download me-2"></i> Exportar Datos
                </button>
            </div>
            
            <div class="alert alert-info mt-4">
                <h6><i class="fas fa-info-circle me-2"></i>Información</h6>
                <p class="small mb-0">
                    Aquí se muestran documentos que cumplen con:
                    <ul class="small mb-0 ps-3 mt-1">
                        <li>Estar en carpetas indexadas</li>
                        <li>Tener OCR generado</li>
                        <li>Tener código de proyecto asignado</li>
                    </ul>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Iniciar para la vista de exportación
        setActiveMode('export');
        loadExportableDocuments();
        
        // Configurar botón de refrescar documentos
        document.getElementById('refreshDocsBtn').addEventListener('click', loadExportableDocuments);
        
        // Configurar botones de reportes
        document.getElementById('generateReportBtn').addEventListener('click', generateReport);
        document.getElementById('exportDataBtn').addEventListener('click', exportData);
    });
    
    // Cargar documentos exportables
    function loadExportableDocuments() {
        const container = document.getElementById('exportableDocsContainer');
        
        // Mostrar indicador de carga
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Cargando documentos...</p>
            </div>
        `;
        
        // Solicitar documentos exportables
        fetch('/get_exportable_documents')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.documents && data.documents.length > 0) {
                    // Crear tabla para mostrar documentos
                    const tableHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Código</th>
                                        <th>Carpeta</th>
                                        <th>Nombre Iniciativa</th>
                                        <th>Caja</th>
                                        <th>Documento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.documents.map(doc => `
                                        <tr>
                                            <td><strong>${doc.codigo || '-'}</strong></td>
                                            <td>${doc.carpeta || '-'}</td>
                                            <td>${doc.nombre_iniciativa || '-'}</td>
                                            <td>${doc.caja || '-'}</td>
                                            <td>
                                                ${doc.pdf_path ? 
                                                    `<a href="/view_pdf?path=${encodeURIComponent(doc.pdf_path)}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-file-pdf me-1"></i> Ver PDF
                                                    </a>` : 
                                                    '<span class="badge bg-warning text-dark">Sin PDF</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-success">
                            <i class="fas fa-info-circle me-2"></i> Se encontraron ${data.documents.length} documentos listos para exportar.
                        </div>
                    `;
                    
                    container.innerHTML = tableHTML;
                } else {
                    // Mostrar mensaje cuando no hay documentos
                    let message = 'No se encontraron documentos para exportar.';
                    if (!data.success) {
                        message = `Error: ${data.error || 'Error desconocido al cargar documentos'}`;
                    }
                    
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i> ${message}
                        </div>
                        <p>Para que un documento aparezca en esta lista debe:</p>
                        <ul>
                            <li>Estar indexado (tener valor en ambas columnas de carpetas.csv)</li>
                            <li>Tener un código de proyecto asignado en db_input.csv</li>
                        </ul>
                    `;
                }
            })
            .catch(error => {
                console.error('Error al cargar documentos:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i> Error al cargar documentos. Por favor, intente nuevamente.
                    </div>
                `;
            });
    }
    
    // Generar reporte de cuadratura
    function generateReport() {
        const button = document.getElementById('generateReportBtn');
        const originalText = button.innerHTML;
        
        // Mostrar indicador de carga
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generando...';
        
        // Descargar reporte directamente
        window.location.href = '/generate_cuadratura';
        
        // Restaurar botón después de un tiempo
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        }, 2000);
    }
    
    // Exportar datos en ZIP
    function exportData() {
        const button = document.getElementById('exportDataBtn');
        const originalText = button.innerHTML;
        
        // Mostrar indicador de carga
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Exportando...';
        
        // Llamar al endpoint de exportación
        fetch('/export_documents', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.innerHTML = originalText;
            
            if (data.success) {
                // Mostrar mensaje de éxito
                alert(`Exportación completada: ${data.document_count} documentos exportados.`);
                
                // Descargar el archivo ZIP
                window.location.href = data.download_url;
            } else {
                // Mostrar mensaje de error
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error al exportar datos:', error);
            button.disabled = false;
            button.innerHTML = originalText;
            alert('Error al procesar la solicitud. Por favor, intente nuevamente.');
        });
    }
</script>
{% endblock %} 