{% extends "base.html" %}

{% block title %}Digitalización{% endblock %}

{% block content %}
<div class="col-md-9">
    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Imágenes</h5>
            <div>
                <button id="scanBtn" class="btn btn-sm btn-success me-2" onclick="scanDocuments()">
                    <i class="fas fa-scanner me-1"></i> Scan
                </button>
                <label for="fileUpload" class="btn btn-sm btn-primary me-2 mb-0">
                    <i class="fas fa-upload me-1"></i> Subir
                </label>
                <input type="file" id="fileUpload" class="d-none" accept=".jpg,.jpeg" multiple>
                <button id="clearBtn" class="btn btn-sm btn-danger">
                    <i class="fas fa-trash me-1"></i> Limpiar
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Grid de imágenes (2 columnas) -->
            <div id="imageGrid" class="row row-cols-1 row-cols-md-2 g-4">
                <!-- Las imágenes se cargarán aquí dinámicamente en 2 columnas -->
            </div>
            
            <!-- Paginación -->
            <div class="d-flex justify-content-between align-items-center mt-4" id="paginationControls" style="display: none;">
                <div>
                    <span class="text-muted">Mostrando <span id="currentRangeStart">1</span>-<span id="currentRangeEnd">10</span> de <span id="totalImages">0</span> imágenes</span>
                </div>
                <div class="btn-group">
                    <button id="prevPageBtn" class="btn btn-outline-secondary" disabled>
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <button id="nextPageBtn" class="btn btn-outline-secondary" disabled>
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-md-3">
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="card-title mb-0">Control de Digitalización</h5>
        </div>
        <div class="card-body">
            <!-- Botón de generar carpeta - visible en modo digitalización -->
            <div class="text-center mb-4" id="digitalizationControls">
                <button id="generateFolderBtn" class="btn btn-success btn-lg w-100" disabled>
                    <i class="fas fa-folder-plus me-2"></i> Crear nueva carpeta
                </button>
                <p class="text-muted small mt-2">
                    Este botón creará una carpeta numerada y moverá todas las imágenes actuales a ella.
                </p>
                <p class="text-muted small" id="noImagesMessage">
                    <i class="fas fa-exclamation-circle"></i> No hay imágenes para mover a una carpeta.
                </p>
            </div>
            
            <!-- Toggle para refresh automático -->
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
                <label class="form-check-label" for="autoRefreshToggle">Refresh automático</label>
                <p class="text-muted small mt-1">
                    Actualizará la página cada 5 segundos para detectar nuevas imágenes.
                </p>
            </div>
            
            <!-- Botón grande para actualizar la página manualmente -->
            <div class="d-grid gap-2 mb-3">
                <button id="refreshPageBtn" class="btn btn-primary btn-lg">
                    <i class="fas fa-sync-alt me-2"></i> Actualizar Página
                </button>
            </div>
            
            <div class="text-center" id="lastUpdateInfo">
                <small class="text-muted">Última actualización: <span id="lastUpdateTime">-</span></small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Variable para controlar si estamos mostrando todas las imágenes o solo las recientes
    let showingAllImages = true; // Cambiado a true por defecto para usar paginación
    // Total de imágenes disponibles
    let totalImages = 0;
    // Variables para paginación
    let currentPage = 1;
    let imagesPerPage = 10;
    let allImages = []; // Almacenar todas las imágenes
    
    document.addEventListener('DOMContentLoaded', function() {
        // Iniciar para la vista de digitalización
        setActiveMode('digitalization');
        setupFileUpload();
        setupClearButton();
        
        // Configurar botón para generar carpeta
        document.getElementById('generateFolderBtn').addEventListener('click', generateFolder);
        
        // Configurar botón para actualizar la página (F5)
        document.getElementById('refreshPageBtn').addEventListener('click', function() {
            window.location.reload();
        });
        
        // Configurar botones de paginación
        document.getElementById('prevPageBtn').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderCurrentPage();
            }
        });
        
        document.getElementById('nextPageBtn').addEventListener('click', function() {
            if (currentPage < Math.ceil(allImages.length / imagesPerPage)) {
                currentPage++;
                renderCurrentPage();
            }
        });
        
        // Configurar toggle de refresh automático
        let autoRefreshInterval = null;
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        
        // Recuperar el estado guardado en localStorage
        const savedAutoRefreshState = localStorage.getItem('autoRefreshEnabled');
        if (savedAutoRefreshState === 'true') {
            autoRefreshToggle.checked = true;
            // Activar refresh automático inmediatamente si estaba activo
            console.log("Restaurando refresh automático activado");
            autoRefreshInterval = setInterval(function() {
                console.log("Realizando refresh automático de la página");
                
                // Guardar estado antes de recargar
                localStorage.setItem('autoRefreshEnabled', 'true');
                
                window.location.reload();  // Recarga completa de la página (F5)
            }, 5000);  // 5 segundos
        }
        
        autoRefreshToggle.addEventListener('change', function() {
            if (this.checked) {
                // Activar refresh automático
                console.log("Refresh automático activado");
                
                // Guardar estado en localStorage
                localStorage.setItem('autoRefreshEnabled', 'true');
                
                autoRefreshInterval = setInterval(function() {
                    console.log("Realizando refresh automático de la página");
                    window.location.reload();  // Recarga completa de la página (F5)
                }, 5000);  // 5 segundos
            } else {
                // Desactivar refresh automático
                console.log("Refresh automático desactivado");
                
                // Guardar estado en localStorage
                localStorage.setItem('autoRefreshEnabled', 'false');
                
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        });
        
        // Asegurarse de limpiar el intervalo si el usuario sale de la página
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
        
        // Actualizar inmediatamente las imágenes al cargar la página
        // Ahora cargamos todas las imágenes para paginarlas
        showingAllImages = true;
        
        // Agregamos un pequeño delay para asegurar que todo esté listo
        setTimeout(function() {
            console.log("Cargando imágenes iniciales...");
            refreshImages();
        }, 100);
        
        // Verificar periódicamente si hay imágenes para habilitar/deshabilitar el botón
        setInterval(checkImagesForFolder, 2000);
    });
    
    // Función para verificar si hay imágenes y actualizar el estado del botón
    function checkImagesForFolder() {
        const imageCount = allImages.length;
        const generateBtn = document.getElementById('generateFolderBtn');
        const noImagesMsg = document.getElementById('noImagesMessage');
        
        if (imageCount > 0) {
            generateBtn.disabled = false;
            noImagesMsg.style.display = 'none';
        } else {
            generateBtn.disabled = true;
            noImagesMsg.style.display = 'block';
        }
    }
    
    // Función para actualizar la cuadrícula de imágenes
    function updateImageGrid(images) {
        // Guardar todas las imágenes
        allImages = images || [];
        
        // Actualizar contador total
        totalImages = allImages.length;
        document.getElementById('totalImages').textContent = totalImages;
        
        // Mostrar/ocultar controles de paginación
        const paginationControls = document.getElementById('paginationControls');
        if (totalImages > imagesPerPage) {
            paginationControls.style.display = 'flex';
        } else {
            paginationControls.style.display = 'none';
        }
        
        // Resetear a la primera página cuando se actualiza la lista completa
        currentPage = 1;
        
        // Renderizar la página actual
        renderCurrentPage();
    }
    
    // Función para renderizar la página actual de imágenes
    function renderCurrentPage() {
        const grid = document.getElementById('imageGrid');
        grid.innerHTML = '';
        
        // Si no hay imágenes
        if (!allImages || allImages.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center p-5"><p>No hay imágenes disponibles</p></div>';
            return;
        }
        
        // Calcular índices de inicio y fin para la página actual
        const startIndex = (currentPage - 1) * imagesPerPage;
        const endIndex = Math.min(startIndex + imagesPerPage, allImages.length);
        
        // Actualizar información de rango
        document.getElementById('currentRangeStart').textContent = startIndex + 1;
        document.getElementById('currentRangeEnd').textContent = endIndex;
        
        // Actualizar estado de los botones de paginación
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = endIndex >= allImages.length;
        
        // Obtener imágenes para la página actual
        const currentImages = allImages.slice(startIndex, endIndex);
        
        console.log(`Mostrando imágenes ${startIndex + 1}-${endIndex} de ${allImages.length}`);
        
        // Mostrar las imágenes en la cuadrícula (en 2 columnas)
        currentImages.forEach(image => {
            const col = document.createElement('div');
            col.className = 'col';
            
            const imageDisplay = image.data || 'static/img/loading.gif';
            const loadingText = image.data ? '' : '<div class="text-center p-2 bg-light">Cargando miniatura...</div>';
            
            col.innerHTML = `
                <div class="card h-100 image-card">
                    <img src="${imageDisplay}" class="card-img-top" alt="${image.name}">
                    ${loadingText}
                    <div class="card-body">
                        <h5 class="card-title">${image.name}</h5>
                        <p class="card-text">${image.modified}</p>
                    </div>
                    <div class="card-footer text-center">
                        <button class="btn btn-sm btn-info me-1" onclick="rotateImage('${image.name}', 'left')">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-sm btn-info me-1" onclick="rotateImage('${image.name}', 'right')">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteImage('${image.name}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Añadimos la imagen al grid
            grid.appendChild(col);
        });
    }
    
    // Función para refrescar las imágenes
    function refreshImages(resetView = false) {
        // No necesitamos resetear la vista ya que ahora siempre mostramos todas las imágenes con paginación
        showingAllImages = true;

        // Mostrar indicador de carga
        const grid = document.getElementById('imageGrid');
        grid.innerHTML = '<div class="col-12 text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Cargando imágenes...</p></div>';
        
        console.log(`Solicitando todas las imágenes para paginación`);
        
        // Solicitar todas las imágenes para la paginación
        fetch('/refresh?sort_by=creation')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Recibidas ${data.images.length} imágenes de ${data.total} totales`);
                    
                    // Actualizar la vista con las nuevas imágenes
                    updateImageGrid(data.images);
                    
                    // Actualizar la hora de última actualización
                    document.getElementById('lastUpdateTime').textContent = data.timestamp;
                    
                    // Verificar si hay imágenes para habilitar/deshabilitar el botón de generar carpeta
                    checkImagesForFolder();
                } else {
                    console.error('Error al obtener imágenes:', data.error);
                    grid.innerHTML = `<div class="col-12 text-center p-5"><div class="alert alert-danger">Error al cargar imágenes: ${data.error}</div></div>`;
                }
            })
            .catch(error => {
                console.error('Error al refrescar imágenes:', error);
                grid.innerHTML = `<div class="col-12 text-center p-5"><div class="alert alert-danger">Error al cargar imágenes: ${error.message}</div></div>`;
            });
    }
    
    // Esta función debe ser accesible globalmente para los botones generados dinámicamente
    function rotateImage(filename, direction) {
        // Mostrar indicador de carga en el botón de rotar
        const rotateButtons = document.querySelectorAll(`button[onclick="rotateImage('${filename}', '${direction}')"]`);
        let originalContent = direction === 'left' ? '<i class="fas fa-undo"></i>' : '<i class="fas fa-redo"></i>';
        if (rotateButtons.length > 0) {
            originalContent = rotateButtons[0].innerHTML;
            rotateButtons.forEach(btn => {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            });
        }
        
        fetch(`/rotate/${encodeURIComponent(filename)}/${direction}`)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        // Si el archivo no se encuentra, actualizar la vista de todas formas
                        console.warn(`Archivo no encontrado para rotar: ${filename}. Actualizando vista de todas formas.`);
                        setTimeout(refreshImages, 500);
                        throw new Error('Archivo no encontrado. La vista se actualizará de todas formas.');
                    }
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mostrar notificación de éxito
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show mt-2';
                    notification.innerHTML = `
                        <small>Imagen "${filename}" rotada correctamente</small>
                        <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.getElementById('imageGrid').prepend(notification);
                    
                    // Auto-ocultar la notificación después de 2 segundos
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 500);
                    }, 2000);
                    
                    // Actualizar imágenes después de la rotación
                    setTimeout(refreshImages, 500);
                } else {
                    console.error('Error al rotar imagen:', data.error);
                    
                    // Mostrar notificación de error
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-danger alert-dismissible fade show mt-2';
                    notification.innerHTML = `
                        <small>Error al rotar imagen: ${data.error}</small>
                        <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.getElementById('imageGrid').prepend(notification);
                    
                    // Restaurar botones si hay error
                    rotateButtons.forEach(btn => {
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    });
                }
            })
            .catch(error => {
                console.error('Error en la solicitud de rotación:', error);
                
                // Mostrar notificación de error
                const notification = document.createElement('div');
                notification.className = 'alert alert-warning alert-dismissible fade show mt-2';
                notification.innerHTML = `
                    <small>${error.message}</small>
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.getElementById('imageGrid').prepend(notification);
                
                // Restaurar botones si hay error
                rotateButtons.forEach(btn => {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                });
            });
    }
    
    // Esta función debe ser accesible globalmente para los botones generados dinámicamente
    function deleteImage(filename) {
        if (confirm(`¿Está seguro de eliminar la imagen ${filename}?`)) {
            // Mostrar indicador de carga en el botón de eliminar
            const deleteButtons = document.querySelectorAll(`button[onclick="deleteImage('${filename}')"]`);
            let originalContent = '<i class="fas fa-trash"></i>';
            if (deleteButtons.length > 0) {
                originalContent = deleteButtons[0].innerHTML;
                deleteButtons.forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    btn.disabled = true;
                });
            }
            
            fetch(`/delete/${encodeURIComponent(filename)}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            // Si el archivo no se encuentra, actualizar la vista de todas formas
                            // ya que podría ser un problema de nombres de archivos con caracteres especiales
                            console.warn(`Archivo no encontrado: ${filename}. Actualizando vista de todas formas.`);
                            setTimeout(refreshImages, 500);
                            throw new Error('Archivo no encontrado. La vista se actualizará de todas formas.');
                        }
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Mostrar notificación de éxito
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-success alert-dismissible fade show mt-2';
                        notification.innerHTML = `
                            <small>Imagen "${filename}" eliminada correctamente</small>
                            <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        document.getElementById('imageGrid').prepend(notification);
                        
                        // Auto-ocultar la notificación después de 3 segundos
                        setTimeout(() => {
                            notification.classList.remove('show');
                            setTimeout(() => notification.remove(), 500);
                        }, 3000);
                        
                        // Actualizar imágenes después de la eliminación
                        setTimeout(refreshImages, 500);
                    } else {
                        console.error('Error al eliminar imagen:', data.error);
                        
                        // Mostrar notificación de error
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-danger alert-dismissible fade show mt-2';
                        notification.innerHTML = `
                            <small>Error al eliminar imagen: ${data.error}</small>
                            <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        document.getElementById('imageGrid').prepend(notification);
                        
                        // Auto-ocultar la notificación después de 5 segundos
                        setTimeout(() => {
                            notification.classList.remove('show');
                            setTimeout(() => notification.remove(), 500);
                        }, 5000);
                        
                        // Restaurar botones si hay error
                        deleteButtons.forEach(btn => {
                            btn.innerHTML = originalContent;
                            btn.disabled = false;
                        });
                        
                        // Actualizar la vista de todas formas después de un tiempo
                        setTimeout(refreshImages, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error en la solicitud de eliminación:', error);
                    
                    // Mostrar notificación de error
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-warning alert-dismissible fade show mt-2';
                    notification.innerHTML = `
                        <small>${error.message}</small>
                        <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.getElementById('imageGrid').prepend(notification);
                    
                    // Auto-ocultar la notificación después de 5 segundos
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 500);
                    }, 5000);
                    
                    // Restaurar botones si hay error
                    deleteButtons.forEach(btn => {
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    });
                });
        }
    }

    // Función para escanear documentos
    function scanDocuments() {
        // Mostrar indicador de carga en el botón
        const scanBtn = document.getElementById('scanBtn');
        const originalContent = scanBtn.innerHTML;
        scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Escaneando...';
        scanBtn.disabled = true;
        
        // Llamar al endpoint de escaneo
        fetch('/scan')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mostrar mensaje de éxito
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show';
                    notification.innerHTML = `
                        <small>Escaneo iniciado correctamente</small>
                        <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.card-header').appendChild(notification);
                    
                    // Auto-ocultar la notificación después de 3 segundos
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 500);
                    }, 3000);
                    
                    // Actualizar imágenes después de un breve retraso
                    setTimeout(refreshImages, 2000);
                    
                    // Restaurar el botón después de un tiempo
                    setTimeout(() => {
                        scanBtn.innerHTML = originalContent;
                        scanBtn.disabled = false;
                    }, 3000);
                } else {
                    console.error('Error al iniciar escaneo:', data.error);
                    
                    // Mostrar mensaje de error
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-danger alert-dismissible fade show';
                    notification.innerHTML = `
                        <small>Error al iniciar escaneo: ${data.error}</small>
                        <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.card-header').appendChild(notification);
                    
                    // Restaurar el botón
                    scanBtn.innerHTML = originalContent;
                    scanBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error en la solicitud de escaneo:', error);
                
                // Mostrar mensaje de error
                const notification = document.createElement('div');
                notification.className = 'alert alert-danger alert-dismissible fade show';
                notification.innerHTML = `
                    <small>Error en la solicitud: ${error.message}</small>
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.card-header').appendChild(notification);
                
                // Restaurar el botón
                scanBtn.innerHTML = originalContent;
                scanBtn.disabled = false;
            });
    }
</script>
{% endblock %} 